let scene, camera, renderer;
let player = { speed: 0.1, health: 100 };
let enemies = [];
let kills = 0;

let moveX = 0;
let moveZ = 0;
let rotX = 0;
let rotY = 0;

function startGame() {
    document.getElementById("menu").style.display = "none";
    document.getElementById("hud").style.display = "block";
    init();
    animate();
}

function init() {

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.y = 1.6;

    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    let light = new THREE.DirectionalLight(0xffffff,1);
    light.position.set(5,10,7);
    scene.add(light);

    let floorGeo = new THREE.PlaneGeometry(200,200);
    let floorMat = new THREE.MeshLambertMaterial({color:0x228B22});
    let floor = new THREE.Mesh(floorGeo,floorMat);
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    // Casas simples
    for(let i=0;i<5;i++){
        let box = new THREE.Mesh(
            new THREE.BoxGeometry(5,5,5),
            new THREE.MeshLambertMaterial({color:0x888888})
        );
        box.position.set(Math.random()*50-25,2.5,Math.random()*50-25);
        scene.add(box);
    }

    spawnEnemies();
    mobileControls();
}

function spawnEnemies(){
    for(let i=0;i<5;i++){
        let enemy = new THREE.Mesh(
            new THREE.BoxGeometry(1,2,1),
            new THREE.MeshLambertMaterial({color:0xff0000})
        );
        enemy.position.set(Math.random()*30-15,1,Math.random()*30-15);
        enemy.health = 50;
        scene.add(enemy);
        enemies.push(enemy);
    }
}

function animate(){
    requestAnimationFrame(animate);

    camera.rotation.y -= rotX * 0.002;
    camera.rotation.x -= rotY * 0.002;
    camera.rotation.x = Math.max(-1.5, Math.min(1.5, camera.rotation.x));

    let forward = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
    let right = new THREE.Vector3(1,0,0).applyQuaternion(camera.quaternion);

    camera.position.add(forward.multiplyScalar(moveZ * player.speed));
    camera.position.add(right.multiplyScalar(moveX * player.speed));

    enemies.forEach(e=>{
        let dir = camera.position.clone().sub(e.position).normalize();
        e.position.add(dir.multiplyScalar(0.02));
    });

    renderer.render(scene,camera);
}

function mobileControls(){

    let joystick = document.getElementById("joystick");
    let stick = document.getElementById("stick");

    joystick.addEventListener("touchmove", e=>{
        let touch = e.touches[0];
        let rect = joystick.getBoundingClientRect();
        let x = touch.clientX - rect.left - 60;
        let y = touch.clientY - rect.top - 60;

        moveX = x/50;
        moveZ = y/50;

        stick.style.left = (x+30)+"px";
        stick.style.top = (y+30)+"px";
    });

    joystick.addEventListener("touchend", ()=>{
        moveX = 0;
        moveZ = 0;
        stick.style.left="30px";
        stick.style.top="30px";
    });

    window.addEventListener("touchmove", e=>{
        if(e.touches.length===1){
            rotX = e.touches[0].movementX || 0;
            rotY = e.touches[0].movementY || 0;
        }
    });

    document.getElementById("shootBtn").addEventListener("touchstart", shoot);
}

function shoot(){
    let raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(new THREE.Vector2(0,0),camera);
    let intersects = raycaster.intersectObjects(enemies);

    if(intersects.length>0){
        let enemy = intersects[0].object;
        enemy.health -= 25;
        if(enemy.health<=0){
            scene.remove(enemy);
            enemies.splice(enemies.indexOf(enemy),1);
            kills++;
            document.getElementById("kills").innerText="Kills: "+kills;
        }
    }
}
